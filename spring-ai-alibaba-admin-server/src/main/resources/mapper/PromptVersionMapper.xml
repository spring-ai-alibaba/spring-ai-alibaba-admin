<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alibaba.cloud.ai.studio.admin.mapper.PromptVersionMapper">

    <!-- Prompt版本表字段 -->
    <sql id="prompt_version_columns">
        id, version, prompt_key, version_desc, template, variables, model_config, status, create_time, previous_version
    </sql>

    <!-- Prompt版本实体映射 -->
    <resultMap id="promptVersionResultMap" type="com.alibaba.cloud.ai.studio.admin.entity.PromptVersionDO">
        <id property="id" column="id"/>
        <result property="version" column="version"/>
        <result property="promptKey" column="prompt_key"/>
        <result property="versionDesc" column="version_desc"/>
        <result property="template" column="template"/>
        <result property="variables" column="variables"/>
        <result property="modelConfig" column="model_config"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="previousVersion" column="previous_version"/>
    </resultMap>

    <!-- 创建Prompt版本 -->
    <insert id="insert" parameterType="com.alibaba.cloud.ai.studio.admin.entity.PromptVersionDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO prompt_version (version, prompt_key, version_desc, template, variables, model_config, status, create_time, previous_version)
        VALUES (#{version}, #{promptKey}, #{versionDesc}, #{template}, #{variables}, #{modelConfig}, #{status}, NOW(), #{previousVersion})
    </insert>

    <!-- 根据Prompt Key和版本获取Prompt版本 -->
    <select id="selectByPromptKeyAndVersion" resultMap="promptVersionResultMap">
        SELECT <include refid="prompt_version_columns"/>
        FROM prompt_version
        WHERE prompt_key = #{promptKey} AND version = #{version}
    </select>

    <!-- 查询Prompt版本列表 -->
    <select id="selectListByPromptKey" resultMap="promptVersionResultMap">
        SELECT <include refid="prompt_version_columns"/>
        FROM prompt_version
        WHERE prompt_key = #{promptKey}
        <if test="status != null and status != 'all'">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询Prompt版本总数 -->
    <select id="selectCountByPromptKey" resultType="int">
        SELECT COUNT(*)
        FROM prompt_version
        WHERE prompt_key = #{promptKey}
        <if test="status != null and status != 'all'">
            AND status = #{status}
        </if>
    </select>

    <!-- 获取最新版本号 -->
    <select id="selectLatestVersion" resultType="string">
        SELECT version
        FROM prompt_version
        WHERE prompt_key = #{promptKey}
        ORDER BY create_time DESC
        LIMIT 1
    </select>

    <!-- 检查版本是否存在 -->
    <select id="existsByPromptKeyAndVersion" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM prompt_version
        WHERE prompt_key = #{promptKey} AND version = #{version}
    </select>

    <!-- 根据Prompt Key和版本获取状态 -->
    <select id="selectStatusByPromptKeyAndVersion" resultType="string">
        SELECT status
        FROM prompt_version
        WHERE prompt_key = #{promptKey} AND version = #{version}
    </select>

    <!-- 更新Prompt版本 -->
    <update id="updateByPromptKeyAndVersion" parameterType="com.alibaba.cloud.ai.studio.admin.entity.PromptVersionDO">
        UPDATE prompt_version
        SET version_desc = #{versionDesc},
            template = #{template},
            variables = #{variables},
            model_config = #{modelConfig},
            status = #{status},
            previous_version = #{previousVersion}
        WHERE prompt_key = #{promptKey} AND version = #{version}
    </update>

    <!-- 根据Prompt Key删除所有版本 -->
    <delete id="deleteByPromptKey">
        DELETE FROM prompt_version WHERE prompt_key = #{promptKey}
    </delete>

</mapper>
