<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alibaba.cloud.ai.studio.admin.mapper.EvaluatorVersionMapper">

    <resultMap id="evaluatorVersionResultMap" type="com.alibaba.cloud.ai.studio.admin.entity.EvaluatorVersionDO">
        <id property="id" column="id"/>
        <result property="evaluatorId" column="evaluator_id"/>
        <result property="description" column="description"/>
        <result property="version" column="version"/>
        <result property="modelConfig" column="model_config"/>
        <result property="prompt" column="prompt"/>
        <result property="variables" column="variables"/>
        <result property="status" column="status"/>
        <result property="experiments" column="experiments"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="table_name">evaluator_version</sql>

    <sql id="base_column_list">
        id, evaluator_id, description, version, model_config, prompt, variables, status, experiments, create_time, update_time
    </sql>

    <!-- 创建评估器版本 -->
    <insert id="insert" parameterType="com.alibaba.cloud.ai.studio.admin.entity.EvaluatorVersionDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO
        <include refid="table_name"/>
        (evaluator_id, description, version, model_config, prompt, variables, create_time, update_time, status, experiments)
        VALUES
        (#{evaluatorId}, #{description}, #{version}, #{modelConfig}, #{prompt}, #{variables}, NOW(), NOW(), #{status}, #{experiments})
    </insert>

    <delete id="deleteById">
        DELETE
        <include refid="table_name"/>
        WHERE id = #{id}
    </delete>

    <!-- 根据ID获取评估器版本 -->
    <select id="selectById" resultMap="evaluatorVersionResultMap">
        SELECT
        <include refid="base_column_list"/>
        FROM
        <include refid="table_name"/>
        WHERE id = #{id}
    </select>

    <!-- 根据评估器ID获取评估器版本列表 -->
    <select id="selectListByEvaluatorId" resultMap="evaluatorVersionResultMap">
        SELECT
        <include refid="base_column_list"/>
        FROM
        <include refid="table_name"/>
        WHERE evaluator_id = #{evaluatorId}
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据评估器ID统计评估器版本数量 -->
    <select id="countByEvaluatorId" resultType="int">
        SELECT COUNT(*) FROM
        <include refid="table_name"/>
        WHERE evaluator_id = #{evaluatorId}
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
    </select>


    <select id="selectLatestVersionByEvaluatorId"
            resultType="com.alibaba.cloud.ai.studio.admin.entity.EvaluatorVersionDO">
        SELECT * FROM
        <include refid="table_name"/>
        WHERE evaluator_id = #{evaluatorId}
                 order by create_time desc limit 1
    </select>


    <update id="update">
        UPDATE
        <include refid="table_name"/>
        SET description = #{description},
            status = #{status},
            update_time = NOW()
        WHERE id = #{id}
    </update>



</mapper>